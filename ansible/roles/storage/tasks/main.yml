---
- name: Create storage mount point
  file:
    path: "{{ storage_mount_point }}"
    state: directory
    mode: '0755'
  become: yes

- name: Create storage subdirectories
  file:
    path: "{{ storage_mount_point }}/{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - home
    - opt
    - docker
    - log
  become: yes

- name: Configure fstab for SD card storage
  template:
    src: fstab.j2
    dest: /etc/fstab
    mode: '0644'
    backup: yes
  become: yes
  notify: Reload systemd

- name: Mount all filesystems
  command: mount -a
  become: yes
  changed_when: false

- name: Create swap file on SD card
  command: fallocate -l {{ sd_swap_size }} {{ storage_mount_point }}/swapfile
  args:
    creates: "{{ storage_mount_point }}/swapfile"
  become: yes
  register: swap_file_created

- name: Set swap file permissions
  file:
    path: "{{ storage_mount_point }}/swapfile"
    mode: '0600'
    owner: root
    group: root
  become: yes

- name: Format swap file
  command: mkswap {{ storage_mount_point }}/swapfile
  become: yes
  when: swap_file_created is changed
  register: mkswap_result

- name: Enable swap file
  command: swapon {{ storage_mount_point }}/swapfile
  become: yes
  when: mkswap_result is changed
